# serial_io.py
# RS485/RS232 í…ìŠ¤íŠ¸ í”„ë ˆì„ íŒŒì„œ & ì¸ì½”ë” (st|...|end)
# -----------------------------------------------------------------------------
# [ê°œìš”]
# - ì´ ëª¨ë“ˆì€ RS-232/RS-485 ê°™ì€ ì§ë ¬ í†µì‹ ìœ¼ë¡œ ì˜¤ê°€ëŠ” "í…ìŠ¤íŠ¸ í”„ë ˆì„"ì„ ë‹¤ë£¹ë‹ˆë‹¤.
# - í”„ë ˆì„ì€ í•­ìƒ "st|"ë¡œ ì‹œì‘í•˜ê³ , "|end"ë¡œ ëë‚©ë‹ˆë‹¤. (ì˜ˆ: st|...|end)
#
# - ì œê³µ ê¸°ëŠ¥
#   (1) SerialLine : ì§ë ¬ í¬íŠ¸ë¥¼ ì—´ê³ /ë‹«ê³ , ìˆ˜ì‹  ë²„í¼ì— ë°ì´í„°ë¥¼ ìŒ“ì•„ ë‘ì—ˆë‹¤ê°€
#                    "st|" ~ "|end" ì‚¬ì´ì˜ 'ì™„ì „í•œ í•œ í”„ë ˆì„'ë§Œ ë¬¸ìì—´ë¡œ êº¼ëƒ„
#   (2) encode_cfg : PC -> PCB ë¡œ ë³´ë‚´ëŠ” ì„¤ì •(CFG) í”„ë ˆì„ì„ ë¬¸ìì—´ë¡œ ìƒì„±
#   (3) parse_dat_frame : PCB -> PC ë¡œ ì˜¨ ë°ì´í„°(DAT) í”„ë ˆì„ì„ ì•ˆì „í•˜ê²Œ íŒŒì‹±
#
# [í…ìŠ¤íŠ¸ í”„ë ˆì„ ê·œì¹™]
#   - í•„ë“œ êµ¬ë¶„ì: SEP = '|'
#   - payload ë‚´ë¶€ ìˆ«ì êµ¬ë¶„ì: ARRSEP = ','
#   - ì‹œì‘ í† í°: "st"  â†’ ì‹¤ì œ í”„ë ˆì„ì€ "st|"
#   - ì¢…ë£Œ í† í°: "end" â†’ ì‹¤ì œ í”„ë ˆì„ì€ "|end"
#
# [íë¦„ë„ - ìˆ˜ì‹  read_frame()]
#   ì§ë ¬í¬íŠ¸ì—ì„œ ë°”ì´íŠ¸ ì½ê¸° â†’ ë‚´ë¶€ ë²„í¼(bytearray)ì— ëˆ„ì 
#     â†’ ë²„í¼ë¥¼ UTF-8 ë¬¸ìì—´ë¡œ ë³€í™˜ â†’ "st|" ìœ„ì¹˜ s / "|end" ìœ„ì¹˜ e ì°¾ê¸°
#     â†’ (s!=-1 and e!=-1 and e>s) ì´ë©´ ì™„ì „ í”„ë ˆì„ì´ë¯€ë¡œ ì˜ë¼ì„œ ë°˜í™˜
#     â†’ ì‚¬ìš©í•œ ë¶€ë¶„ì€ ë²„í¼ì—ì„œ ì œê±°, ë‚˜ë¨¸ì§€ëŠ” ë‹¤ìŒ ìˆ˜ì‹ ì— í™œìš©
#
# [íë¦„ë„ - ì†¡ì‹  encode_cfg()]
#   ì…ë ¥ íŒŒë¼ë¯¸í„°ë“¤ì„ ë¬¸ìì—´ë¡œ ë³€í™˜ â†’ '|'ë¡œ ì´ì–´ë¶™ì„
#     â†’ ë§¨ ì•ì— ST, ë§¨ ë’¤ì— END í¬í•¨ â†’ í•œ ì¤„ ë¬¸ìì—´ë¡œ ë°˜í™˜
#
# [íë¦„ë„ - íŒŒì‹± parse_dat_frame()]
#   ìœ íš¨ì„± ê²€ì‚¬("st|"ë¡œ ì‹œì‘? "|end"ë¡œ ë?) â†’ ì–‘ë í† í° ì œê±° â†’ '|'ë¡œ 6í•„ë“œ split
#     â†’ ë©”íƒ€ í•„ë“œë“¤ í˜•ë³€í™˜ â†’ payloadë¥¼ ','ë¡œ splití•˜ì—¬ float ë¦¬ìŠ¤íŠ¸(ê¸¸ì´ 24)
#     â†’ ì˜ë¯¸ë³„ ìŠ¬ë¼ì´ìŠ¤(raw8, ravg4, chë³„ y2/y3/yt) â†’ ë”•ì…”ë„ˆë¦¬/ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜
# -----------------------------------------------------------------------------


from __future__ import annotations
import serial, threading, time


# â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€* í”„ë¡œí† ì½œ ìƒìˆ˜ â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*
SEP = "|"      # í•„ë“œ(ì—´) êµ¬ë¶„ì. ì˜ˆ: st|í•„ë“œ1|í•„ë“œ2|...|end
ARRSEP = ","   # payload ë‚´ë¶€ì˜ ì—¬ëŸ¬ ìˆ«ìë¥¼ ë‚˜ëˆŒ ë•Œ ì‚¬ìš©ë˜ëŠ” êµ¬ë¶„ì. ì˜ˆ: 1.0,2.0,3.0
ST = "st"      # ì‹œì‘ í† í°(ë…¼ë¦¬ëª…). ì‹¤ì œ í”„ë ˆì„ì€ í•­ìƒ "st|"
END = "end"    # ì¢…ë£Œ í† í°(ë…¼ë¦¬ëª…). ì‹¤ì œ í”„ë ˆì„ì€ í•­ìƒ "|end"
# â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*



class SerialLine:
    """ë¼ì¸ ë‹¨ìœ„ ì½ê¸°/ì“°ê¸°. ë²„í¼ì—ì„œ st~end ì‚¬ì´ í”„ë ˆì„ë§Œ ì¶”ì¶œ.
    - ì§ë ¬ í¬íŠ¸ë¥¼ ì—´ì–´ ë‘ê³ , ìˆ˜ì‹  ë°”ì´íŠ¸ë¥¼ ë‚´ë¶€ ë²„í¼(self.buf)ì— ëˆ„ì í•œë‹¤.
    - ëˆ„ì ëœ ë¬¸ìì—´ì—ì„œ 'st|'ì™€ '|end' ì‚¬ì´ì˜ ì™„ì „í•œ í”„ë ˆì„ì„ ì°¾ì•„ ë¬¸ìì—´ë¡œ ë°˜í™˜í•œë‹¤.
    """
    
    def __init__(self, port: str, baud: int = 115200, timeout: float = 0.1):
        # port: 'COM3' ë˜ëŠ” '/dev/ttyUSB0' ê°™ì€ ì‹¤ì œ í¬íŠ¸ ê²½ë¡œ/ì´ë¦„
        # baud: í†µì‹  ì†ë„(bps). RS-485/232ì—ì„œ í”íˆ ì“°ëŠ” 115200ì„ ê¸°ë³¸ìœ¼ë¡œ
        # timeout: read() ëŒ€ê¸° ì‹œê°„(ì´ˆ). 0.1ì´ˆ ëŒ€ê¸° í›„ ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ë°”ì´íŠ¸ ë°˜í™˜
        self.ser = serial.Serial(port=port, baudrate=baud, timeout=timeout)
        self.buf = bytearray()          # ìˆ˜ì‹  ëˆ„ì  ë²„í¼(ë°”ì´íŠ¸ ë‹¨ìœ„ ì €ì¥)
        self.lock = threading.Lock()    # ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë²„í¼ ì¡°ì‘ ë³´í˜¸ìš©

    def close(self):
        # ì§ë ¬ í¬íŠ¸ë¥¼ ë‹«ëŠ”ë‹¤. ì¢…ë£Œ ì‹œ ì˜ˆì™¸ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ(í…ŒìŠ¤íŠ¸/ì¢…ë£Œ í¸ì˜)
        try: self.ser.close()
        except: pass

    def write_line(self, text: str):
        # í•­ìƒ '\n'ë¡œ ì¢…ë£Œ
        # - ì†¡ì‹ ì€ "í•œ ì¤„"ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²Œ ì•ˆì „/ë¡œê·¸ í¸ì˜ì— ì¢‹ë‹¤.
        # - ë§Œì•½ ì¤„ ëì— ê°œí–‰ì´ ì—†ë‹¤ë©´ ë¶™ì—¬ ì¤€ë‹¤.
        if not text.endswith("\n"): text += "\n"
        
        print(f"[TX LOG] Sending: {text.strip()}") # í„°ë¯¸ë„ ë¡œê·¸ì—ì„œ PC -> PCB ì „ì†¡ í™•ì¸ëŠ” ë¡œê·¸
        
        self.ser.write(text.encode("utf-8"))    # í…ìŠ¤íŠ¸ë¥¼ UTF-8 ë°”ì´íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
        self.ser.flush()                        # OS/ë“œë¼ì´ë²„ ë²„í¼ë¡œ ì¦‰ì‹œ ë°€ì–´ ë„£ê¸°

    def read_frame(self) -> str | None:
        """ìŠ¤íŠ¸ë¦¼ì—ì„œ 'st|'ë¡œ ì‹œì‘í•´ '|end'ë¡œ ëë‚˜ëŠ” í•œ í”„ë ˆì„(ë¬¸ìì—´)ì„ ë°˜í™˜
        ë°˜í™˜:
          - ì™„ì „í•œ í”„ë ˆì„ ë¬¸ìì—´ (ì˜ˆ: 'st|...|end') â†’ í”„ë ˆì„ ê²½ê³„ê¹Œì§€ ë„ë‹¬í•œ ê²½ìš°
          - None â†’ ì•„ì§ ê²½ê³„ê°€ ì™„ì„±ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë°©ê¸ˆ ì½ì€ ë°”ì´íŠ¸ê°€ ì—†ëŠ” ê²½ìš°
        """
        chunk = self.ser.read(1024)  # ì´ë²ˆ í˜¸ì¶œì—ì„œ ìƒˆë¡œ ìˆ˜ì‹ ëœ ë°”ì´íŠ¸(ìµœëŒ€ 1024)
        if not chunk:
            return None              # ì•„ì§ ë“¤ì–´ì˜¨ ê²Œ ì—†ìœ¼ë©´ ì¼ë‹¨ None
        with self.lock:              # ë²„í¼ ë™ì‹œ ì ‘ê·¼ì„ ë§‰ê¸° ìœ„í•´ ë½ ì‚¬ìš©
            self.buf.extend(chunk)   # ìƒˆ ë°”ì´íŠ¸ë¥¼ ë‚´ë¶€ ëˆ„ì  ë²„í¼ì— ì¶”ê°€
            
             # ëˆ„ì  ë²„í¼ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜. ê¹¨ì§„ ë°”ì´íŠ¸ê°€ ìˆì–´ë„ ë¬´ì‹œí•˜ê³  ì´ì–´ì„œ í•´ì„
            data = self.buf.decode("utf-8", errors="ignore")  
            
            # stì˜ ì‹œì‘ê³¼ endì˜ ìœ„ì¹˜ íƒìƒ‰
            s = data.find("st" + SEP)     # 'st|' ìœ„ì¹˜
            e = data.find(SEP + "end")    # '|end' ìœ„ì¹˜
            if s != -1 and e != -1 and e > s:
                # s~e ì‚¬ì´ê°€ ì™„ì „í•œ í”„ë ˆì„ êµ¬ê°„. ë í† í°ê¹Œì§€ í¬í•¨í•˜ì—¬ ì¶”ì¶œ
                frame = data[s:e+len(SEP+"end")]
                
                # ì†Œë¹„í•œ ë§Œí¼ ë²„í¼ì—ì„œ ì œê±°(í”„ë ˆì„ ë’¤ì— ë‚¨ì€ ê¼¬ë¦¬ ë¬¸ìì—´ë§Œ ìœ ì§€)
                remain = data[e+len(SEP+"end"):]
                self.buf = bytearray(remain.encode("utf-8"))
                return frame.strip()    # í˜¹ì‹œ ëª¨ë¥¼ ì•ë’¤ ê³µë°± ì œê±° í›„ ë°˜í™˜
        return None   # ì•„ì§ í”„ë ˆì„ì´ ì™„ì„±ë˜ì§€ ì•ŠìŒ


# â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*  PC -> PCB : ì„¤ì •(Configuration) í”„ë ˆì„ 11í•„ë“œ ì¸ì½”ë” â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*
"""
PC â†’ PCB ì„¤ì • í”„ë ˆì„ì€
'|' ê¸°ì¤€ 11í•„ë“œ(ìŠ¤ì¹¼ë¼ 7 + ë°°ì—´ 4)ë¡œ êµ¬ì„±ëœ ê³ ì • í”„ë ˆì„ êµ¬ì¡°ì´ë©°,
ê° ë°°ì—´ í•„ë“œëŠ” ',' ë¡œ êµ¬ë¶„ëœ ê³ ì • ê¸¸ì´ ê°’(y1[6], y2[6], y3[6], yt[2])ì„ í¬í•¨í•œë‹¤.
ì „ì²´ ë°ì´í„° ê°’ ê°œìˆ˜ëŠ” 27ê°œë‹¤
"""

def validate_cfg_args(
    lpf_cutoff_hz, sampling_rate, target_rate,
    movavg_r, movavg_ch, channel_mask, block_size,
    coeffs_y1, coeffs_y2, coeffs_y3, coeffs_yt,
):
    """
    encode_cfg() í˜¸ì¶œ ì „ ì¸ì ê²€ì¦ìš© í•¨ìˆ˜.
    ëª©ì :
      - íŒŒë¼ë¯¸í„° íƒ€ì…/ê¸¸ì´/ë²”ìœ„ë¥¼ ë¯¸ë¦¬ ì ê²€í•˜ì—¬, ì˜ëª»ëœ ì„¤ì • í”„ë ˆì„ ì „ì†¡ì„ ì˜ˆë°©.
      - íŒì›¨ì–´ì—ì„œ NACK/ì˜¤ë™ì‘ì„ ì¼ìœ¼í‚¤ëŠ” ê°’ì´ ì• ì´ˆì— ì†¡ì‹ ë˜ì§€ ì•Šë„ë¡ ë°©ì§€.

    ê²€ì¦ í•­ëª© ìš”ì•½:
      1) ë°°ì—´ ê¸¸ì´ ê³ ì •: y1=6, y2=6, y3=6, yt=2
      2) ìˆ«ìì„±(í˜•ë³€í™˜ ê°€ëŠ¥ì„±): float/int ë³€í™˜ì´ ê°€ëŠ¥í•œì§€ ì‚¬ì „ í™•ì¸
      3) ê¸°ë³¸ ë²”ìœ„:
         - sampling_rate > 0
         - block_size > 0
         - 0 <= channel_mask <= 255  (8ì±„ë„ ê³ ì • ì‹œ 255 ê¶Œì¥)

    ì˜ˆì™¸:
      - ì¡°ê±´ ë¶ˆë§Œì¡± ì‹œ ValueError ë°œìƒ â†’ í˜¸ì¶œë¶€ì—ì„œ try/exceptë¡œ í•¸ë“¤ë§
    """
    
    # 1) íƒ€ì… ë° ê¸¸ì´ ê²€ì¦ (ë°°ì—´ ê¸¸ì´ ê³ ì • ê·œì¹™)
    if len(coeffs_y1) != 6 or len(coeffs_y2) != 6 or len(coeffs_y3) != 6 or len(coeffs_yt) != 2:
        raise ValueError("coeffs lengths must be y1=6, y2=6, y3=6, yt=2")


    # 2) ìˆ«ìí˜• ë³€í™˜ ê°€ëŠ¥ ì—¬ë¶€ (í˜•/ë¬¸ì í˜¼ì… ë°©ì§€)
    _ = float(lpf_cutoff_hz); _ = float(sampling_rate); _ = float(target_rate)
    _ = int(movavg_r); _ = int(movavg_ch); _ = int(block_size)
    _ = int(channel_mask)   # 0~255 ê¶Œì¥
    for arr in (coeffs_y1, coeffs_y2, coeffs_y3, coeffs_yt):
        for v in arr:
            _ = float(v)    # ê° ê³„ìˆ˜ê°€ ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜ ê°€ëŠ¥í•œì§€ í™•ì¸


    # 3) ê°’ ë²”ìœ„(í•„ìš”ì‹œ í”„ë¡œì íŠ¸ ìš”êµ¬ì— ë§ê²Œ ì¡°ì • ê°€ëŠ¥)
    if not (0 < float(sampling_rate)):
        raise ValueError("sampling_rate must be > 0")
    if not (0 < int(block_size)):
        raise ValueError("block_size must be > 0")
    if not (0 <= int(channel_mask) <= 255):
        raise ValueError("channel_mask must be 0..255")


def encode_cfg(
    lpf_cutoff_hz: float,         # ì €ì—­í†µê³¼í•„í„° ì»·ì˜¤í”„ ì£¼íŒŒìˆ˜(Hz)
    sampling_rate: float | int,   # ìƒ˜í”Œë§ ë ˆì´íŠ¸(Hz)
    target_rate: float,           # (ì˜µì…˜) ë¦¬í¬íŠ¸/ë‹¤ìš´ìƒ˜í”Œ ëª©í‘œ ë ˆì´íŠ¸(Hz)
    movavg_r: int,                # ì´ë™í‰ê·  R íŒŒë¼ë¯¸í„°(ì˜ˆ: ì°½ ê¸¸ì´/ê³„ìˆ˜)
    movavg_ch: int,               # ì±„ë„ í‰ê·  íŒŒë¼ë¯¸í„°(ì˜ˆ: ì°½ ê¸¸ì´/ê³„ìˆ˜)
    channel_mask: int,            # 8ì±„ë„ ê³ ì •ì´ë©´ 255(0xFF). ë¹„íŠ¸ë§ˆìŠ¤í¬
    block_size: int,              # ì²˜ë¦¬/ì „ì†¡ ë¸”ë¡ í¬ê¸°(ìƒ˜í”Œ ê°œìˆ˜ ë“±)
    coeffs_y1: list[float],       # y1 ê³„ì‚° ê³„ìˆ˜ 6ê°œ
    coeffs_y2: list[float],       # y2 ê³„ì‚° ê³„ìˆ˜ 6ê°œ
    coeffs_y3: list[float],       # y3 ê³„ì‚° ê³„ìˆ˜ 6ê°œ
    coeffs_yt: list[float],       # yt ê³„ì‚° ê³„ìˆ˜ 2ê°œ
) -> str:
     # ë‚´ë¶€ í—¬í¼: ìˆ«ì ë¦¬ìŠ¤íŠ¸ â†’ '1.0,2.0,3.0' í˜•íƒœ ë¬¸ìì—´ë¡œ ë³€í™˜
    def arr(xs): return ARRSEP.join(str(x) for x in xs)
    
    # CFG í”„ë ˆì„ì€ "st| ... |end" í•œ ì¤„ë¡œ êµ¬ì„±í•œë‹¤.
    # ë‚˜ì¤‘ì— write_line()ì—ì„œ \nì„ ë¶™ì—¬ ì†¡ì‹ í•œë‹¤. (ì—¬ê¸°ì„œëŠ” ê°œí–‰ ì—†ì´ joinë§Œ)
    fields = [
        ST,                        # ì‹œì‘ í† í°(st)
        str(lpf_cutoff_hz),        # LPF ì»·ì˜¤í”„
        str(sampling_rate),        # ìƒ˜í”Œë§ ë ˆì´íŠ¸
        str(target_rate),          # íƒ€ê¹ƒ ë ˆì´íŠ¸
        str(movavg_r),             # ì´ë™í‰ê·  R
        str(movavg_ch),            # ì±„ë„ í‰ê· 
        str(channel_mask),         # ì±„ë„ ë§ˆìŠ¤í¬
        str(block_size),           # ë¸”ë¡ í¬ê¸°
        arr(coeffs_y1),            # y1 ê³„ìˆ˜ 6ê°œë¥¼ ì½¤ë§ˆë¡œ ì´ì–´ë¶™ì„
        arr(coeffs_y2),            # y2 ê³„ìˆ˜ 6ê°œ
        arr(coeffs_y3),            # y3 ê³„ìˆ˜ 6ê°œ
        arr(coeffs_yt),            # yt ê³„ìˆ˜ 2ê°œ
        END,                       # ì¢…ë£Œ í† í°(end)
    ]
    # ì‹œê°í™”ë¥¼ ìœ„í•´ ê°œí–‰ì„ ë„£ë˜ ì˜ˆì‹œëŠ” ì‹¤ì œ ì „ì†¡ì—ì„  í•œ ì¤„ì´ì–´ì•¼ í•˜ë¯€ë¡œ joinë§Œ ì‚¬ìš©
    return SEP.join(fields)


# â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*

"""
PC -> PCB ì˜ˆì‹œ í”„ë ˆì„ êµ¬ì¡°

st|6970.0|550.0|1270.0|2413|192|255|25600|
10.0,10.0,10.0,10.0,10.0,10.0|
0.0,0.0,0.0,0.0,1.0,0.0|
0.0,0.0,0.0,0.0,1.0,0.0|
55.0,23.0|end

íŒŒì´í”„ í•„ë“œ ìˆ˜: 11
(st / 7 ìŠ¤ì¹¼ë¼ / 4 ë°°ì—´ / end)

ë°°ì—´ ê¸¸ì´: y1=6, y2=6, y3=6, yt=2 (ê³ ì •)

: ì „ì²´ ë°ì´í„° ê°’ ê°œìˆ˜ëŠ” 27ê°œ
"""


# â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€* PCB -> PC : ë°ì´í„°(Data) í”„ë ˆì„ ë””ì½”ë” â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*â”€â”€â”€â”€*
def parse_dat_frame(frame: str):
    """
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ğŸ“¡ PCB -> PC : ë°ì´í„°(Data) í”„ë ˆì„ êµ¬ì¡° ì˜ˆì‹œ
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        â–¶ í”„ë ˆì„ ê°œìš”
            â€¢ í•˜ë‚˜ì˜ í”„ë ˆì„ì€ 'st' ë¡œ ì‹œì‘í•˜ê³  'end' ë¡œ ëë‚œë‹¤.
            â€¢ í•„ë“œ êµ¬ë¶„ìëŠ” '|' (íŒŒì´í”„)
            â€¢ ë°°ì—´ ë‚´ë¶€ êµ¬ë¶„ìëŠ” ',' (ì½¤ë§ˆ)
            â€¢ ì´ 6í•„ë“œ ê³ ì • (ë©”íƒ€ 5 + payload 1)
                [block_count, timestamp_ms, sampling_rate, block_size, channel_mask, payload(24ê°œ)]

        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â–¶ ë°ì´í„° êµ¬ì„±

        st|block_count|timestamp_ms|sampling_rate|block_size|channel_mask|payload(24)|end
            â†‘              â†‘             â†‘             â†‘            â†‘             â†‘
        (1) ë¸”ë¡ë²ˆí˜¸   (2) íƒ€ì„ìŠ¤íƒ¬í”„  (3) ìƒ˜í”Œë ˆì´íŠ¸ (4) ë¸”ë¡í¬ê¸°  (5) í™œì„±ì±„ë„  (6) ë°ì´í„°(24ê°œ)

        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â–¶ payload(24) ë‚´ë¶€ êµ¬ì¡° (ê³ ì • ê¸¸ì´)

            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ êµ¬ê°„(ì¸ë±ìŠ¤)   â”‚ ì„¤ëª…                         â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  0 ~ 7       â”‚ RAW8  (8ì±„ë„ ì›ì‹œ ê°’)         â”‚
            â”‚  8 ~ 11      â”‚ RAVG4 (4ì±„ë„ í‰ê· ê°’)          â”‚
            â”‚ 12 ~ 14      â”‚ ch0 : y2, y3, yt            â”‚
            â”‚ 15 ~ 17      â”‚ ch1 : y2, y3, yt            â”‚
            â”‚ 18 ~ 20      â”‚ ch2 : y2, y3, yt            â”‚
            â”‚ 21 ~ 23      â”‚ ch3 : y2, y3, yt            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†’ ì´ 24ê°œì˜ float ê³ ì •

        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â–¶ ì‹¤ì œ ì „ì†¡ ì˜ˆì‹œ

        st|1234|1729145678123|1000|1024|255|
        0.10,0.08,0.07,0.05,0.04,0.03,0.02,0.01,
        0.12,0.09,0.03,0.11,
        0.21,0.31,0.41,
        0.22,0.32,0.42,
        0.23,0.33,0.43,
        0.24,0.34,0.44|end

        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â–¶ êµ¬ì¡° ìš”ì•½
            â€¢ íŒŒì´í”„ í•„ë“œ ìˆ˜: 6
                (st / 5 ë©”íƒ€ / 1 í˜ì´ë¡œë“œ / end)
            â€¢ payload ë‚´ë¶€ ê¸¸ì´: 24 (ê³ ì •)
            â€¢ ì´ ë°ì´í„° ê°’ ìˆ˜: 24 + 5 = 29ê°œ (ë‹¨, st/end ì œì™¸)
            â€¢ st, end ëŠ” í”„ë ˆì„ ì œì–´ í† í°ìœ¼ë¡œ ë°ì´í„°ì— í¬í•¨ë˜ì§€ ì•ŠìŒ
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    """
    
    # 1) í”„ë ˆì„ ì–‘ë ë§ˆì»¤ í™•ì¸: 'st|'ë¡œ ì‹œì‘ & '|end'ë¡œ ëë‚˜ì•¼ í•¨
    if not frame.startswith("st|") or not frame.endswith("|end"):
        raise ValueError("Invalid frame markers")
    
    
    # 2) ì–‘ë ë§ˆì»¤ ì œê±°: ì•ì˜ 'st|' 3ê¸€ì, ë’¤ì˜ '|end' 4ê¸€ì
    core = frame[3:-4]  # 'st|'ì™€ '|end' ì œê±°
    
    
    # 3) í•„ë“œ ìª¼ê°œê¸°: '|' ê¸°ì¤€ìœ¼ë¡œ ì´ 6ê°œì—¬ì•¼ ì •ìƒ
    parts = core.split(SEP)
    if len(parts) != 6:   # ë©”íƒ€5 + payload1 = 6, (ì´ë¯¸ 'st' ì œê±°ë¨)
        # parts=[block_count,timestamp_ms,sampling_rate,block_size,channel_mask,payload]
        # ì´ 6ì—¬ì•¼ ì •ìƒ. (ìœ„ì—ì„œ 3:-4 í–ˆìœ¼ë‹ˆ 'st'ì™€ 'end'ëŠ” ì—†ìŒ)
        raise ValueError(f"Invalid DAT fields: expected 6, got {len(parts)}")


    # 4) ë©”íƒ€ í•„ë“œ íŒŒì‹±/í˜•ë³€í™˜
    block_count    = int(parts[0])
    timestamp_ms   = int(parts[1])
    sampling_rate  = float(parts[2])
    block_size     = int(parts[3])
    channel_mask   = parts[4]   # ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ë‘ (í˜¸ì¶œë¶€ì—ì„œ í•„ìš” ì‹œ int(...) ì²˜ë¦¬)
    payload_str    = parts[5]


    # 5) payload íŒŒì‹±: ì½¤ë§ˆë¡œ ë‚˜ëˆ„ì–´ floatë¡œ ë³€í™˜. ë¹ˆ í•­ëª©ì€ ì œì™¸
    payload = [float(x) for x in payload_str.split(ARRSEP) if x.strip() != ""]
    if len(payload) != 24:
        # ê¸¸ì´ê°€ ë‹¤ë¥´ë©´ í”„ë¡œí† ì½œ ë¶ˆì¼ì¹˜ â†’ ì¦‰ì‹œ ì˜ˆì™¸ë¡œ ì•Œë ¤ ë¬¸ì œë¥¼ ë¹ ë¥´ê²Œ ë°œê²¬
        raise ValueError(f"Payload length must be 24, got {len(payload)}")


    # 6) ì±„ë„ìš°ì„  ì¸ë±ì‹± ë¶„í•´ (ì˜ë¯¸ëŒ€ë¡œ ì˜ë¼ì„œ ì‚¬ìš©í•˜ê¸° í¸í•˜ê²Œ)
    raw8 = payload[0:8]     # ì›ì‹œ 8ì±„ë„ ê°’
    ravg4 = payload[8:12]   # í‰ê· /ê°€ê³µ 4ì±„ë„ ê°’
    
    
    # ch0~ch3ì˜ (y2, y3, yt) 3ê°œì”©
    ch0_y2, ch0_y3, ch0_yt = payload[12:15]
    ch1_y2, ch1_y3, ch1_yt = payload[15:18]
    ch2_y2, ch2_y3, ch2_yt = payload[18:21]
    ch3_y2, ch3_y3, ch3_yt = payload[21:24]
    
    
    # ìŠ¤í…Œì´ì§€ë³„ ë¬¶ìŒ í˜•íƒœë¡œë„ ì œê³µ
    stage7_y2 = [ch0_y2, ch1_y2, ch2_y2, ch3_y2]
    stage8_y3 = [ch0_y3, ch1_y3, ch2_y3, ch3_y3]
    yt4       = [ch0_yt, ch1_yt, ch2_yt, ch3_yt]


    # 7) ë©”íƒ€ + ë¶„í•´ëœ ë°°ì—´ë“¤ì„ íŠœí”Œë¡œ ë°˜í™˜
    meta = dict(
        block_count=block_count,
        timestamp_ms=timestamp_ms,
        sampling_rate=sampling_rate,
        block_size=block_size,
        channel_mask=channel_mask,
    )
    return meta, raw8, ravg4, stage7_y2, stage8_y3, yt4


